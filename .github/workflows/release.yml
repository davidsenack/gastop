name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run tests
        run: go test ./...

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          LDFLAGS="-s -w -X main.version=${VERSION}"

          # Darwin AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o gastop ./cmd/gastop
          tar -czf gastop-${VERSION}-darwin-amd64.tar.gz gastop
          rm gastop

          # Darwin ARM64
          GOOS=darwin GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o gastop ./cmd/gastop
          tar -czf gastop-${VERSION}-darwin-arm64.tar.gz gastop
          rm gastop

          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o gastop ./cmd/gastop
          tar -czf gastop-${VERSION}-linux-amd64.tar.gz gastop

          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags "${LDFLAGS}" -o gastop-arm64 ./cmd/gastop
          tar -czf gastop-${VERSION}-linux-arm64.tar.gz gastop-arm64
          rm gastop-arm64

          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o gastop.exe ./cmd/gastop
          zip gastop-${VERSION}-windows-amd64.zip gastop.exe
          rm gastop.exe

          # Generate checksums
          shasum -a 256 *.tar.gz *.zip > checksums.txt

      - name: Build Debian package (amd64)
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PKG_DIR="gastop_${VERSION}_amd64"

          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin

          cp gastop ${PKG_DIR}/usr/bin/
          rm gastop

          cat > ${PKG_DIR}/DEBIAN/control << EOF
          Package: gastop
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: David Senack <david.senack@gmail.com>
          Description: Terminal dashboard for Gas Town workspaces
           An htop-like terminal UI for monitoring Gas Town multi-agent
           workspaces. Track convoys, beads, and polecats in real time.
          Homepage: https://github.com/davidsenack/gastop
          EOF

          dpkg-deb --build ${PKG_DIR}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.tar.gz
            *.zip
            *.deb
            checksums.txt
          generate_release_notes: true

      - name: Setup apt repository
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          mkdir -p apt-repo/pool/main
          mkdir -p apt-repo/dists/stable/main/binary-amd64

          cp *.deb apt-repo/pool/main/

          cd apt-repo
          dpkg-scanpackages pool/main > dists/stable/main/binary-amd64/Packages
          gzip -k dists/stable/main/binary-amd64/Packages

          cat > dists/stable/Release << EOF
          Origin: gastop
          Label: gastop
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: gastop - Terminal dashboard for Gas Town
          EOF

          # Add package info to Release
          echo "SHA256:" >> dists/stable/Release
          sha256sum dists/stable/main/binary-amd64/Packages | awk '{print " "$1" "length" main/binary-amd64/Packages"}' >> dists/stable/Release
          sha256sum dists/stable/main/binary-amd64/Packages.gz | awk '{print " "$1" "length" main/binary-amd64/Packages.gz"}' >> dists/stable/Release

      - name: Upload apt repo artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apt-repo

  deploy-apt:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
